<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Управление Email адресами</title>

    <!-- Bootstrap 5 -->
    <link
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
        rel="stylesheet"
    >

    <style>
        body {
            background-color: #f8f9fa;
            transition: all 0.5s ease;
        }

        .content-wrapper {
            width: 80%;
            max-width: 80%;
            margin: 0 auto;
            transition: all 0.5s ease;
        }

        @media (max-width: 1000px) {
            .content-wrapper {
                width: 100%;
                max-width: 100%;
                padding: 0 10px;
            }
        }

        .card, .table-wrapper, .d-flex {
            transition: all 0.4s ease;
        }

        .table-wrapper {
            width: 100%;
            overflow-x: auto;
        }

        table {
            width: 100%;
            table-layout: auto;
            transition: all 0.4s ease;
        }

        th, td {
            font-size: 14px;
            padding: 0.5rem;
            vertical-align: middle;
            transition: all 0.4s ease;
        }

        #rowCount {
            font-weight: 500;
            margin-bottom: 0.5rem;
            transition: all 0.4s ease;
        }

        .controls select, .controls button {
            transition: all 0.4s ease;
        }

        .user-logout {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .upload-area {
            min-height: 150px;
            border: 2px dashed #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            background-color: #f8f9fa;
            transition: all 0.3s ease;
        }

        .upload-area:hover {
            border-color: #0d6efd;
            background-color: #e7f1ff;
        }

        .upload-area.dragover {
            border-color: #0d6efd;
            background-color: #cfe2ff;
        }

        #emailList {
            font-family: monospace;
            font-size: 14px;
            resize: vertical;
        }

        .alert-custom {
            margin-top: 1rem;
        }

        /* Отступ снизу страницы */
        body {
            padding-bottom: 2rem;
        }

        .content-wrapper {
            padding-bottom: 2rem;
        }
    </style>
</head>
<body>

<div class="container-fluid mt-4 content-wrapper">

    <!-- Header -->
    <div class="card shadow-sm mb-4 position-relative">
        <div class="card-body">
            <div>
                <h3 class="card-title text-primary mb-2">
                    Управление Email адресами
                </h3>
                <div class="d-flex gap-2 mb-2">
                    <a href="/" class="btn btn-outline-secondary btn-sm">Dashboard</a>
                    <a href="/emails" class="btn btn-primary btn-sm">Email адреса</a>
                    <a href="/analytics" class="btn btn-outline-success btn-sm">Аналитика</a>
                </div>
            </div>

            <!-- Пользователь и кнопка Выйти -->
            <div class="user-logout">
                <div class="text-muted small mb-0">{{ session.username }}</div>
                <a href="/logout" class="btn btn-outline-secondary btn-sm">Выйти</a>
            </div>
        </div>
    </div>

    <!-- Загрузка Email -->
    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <h5 class="card-title mb-3">Загрузить Email адреса</h5>
            
            <div class="upload-area mb-3" id="uploadArea">
                <p class="text-center text-muted mb-2">
                    Перетащите файл сюда или введите email адреса в поле ниже
                </p>
                <p class="text-center text-muted small">
                    Поддерживаемые форматы: .xlsx, .txt, .csv (по одному на строку или через запятую)
                </p>
            </div>

            <div class="mb-3">
                <label for="emailList" class="form-label">Список Email адресов:</label>
                <textarea 
                    class="form-control" 
                    id="emailList" 
                    rows="8" 
                    placeholder="user1@example.com&#10;user2@example.com&#10;user3@example.com"
                ></textarea>
                <div class="form-text">
                    Введите email адреса, каждый с новой строки или через запятую
                </div>
            </div>

            <button class="btn btn-primary" onclick="uploadEmails()">
                Загрузить Email адреса
            </button>

            <div id="uploadResult" class="alert-custom"></div>
        </div>
    </div>

    <!-- Controls -->
    <div class="d-flex justify-content-between align-items-center mb-3 controls flex-wrap gap-2">
        <div>
            <button class="btn btn-danger btn-sm" onclick="deleteSelected()">
                Удалить выбранные
            </button>
        </div>
    </div>

    <!-- Количество записей -->
    <p id="rowCount" class="text-muted"></p>

    <!-- Table -->
    <div class="card shadow-sm table-wrapper">
        <div class="card-body p-0">
            <table class="table table-striped table-hover table-sm mb-0" id="emailsTable">
                <thead class="table-dark">
                    <tr>
                        <th style="width:40px">
                            <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                        </th>
                        <th>ID</th>
                        <th>Email адрес</th>
                        <th>Ссылка для трекинга</th>
                        <th>Статус</th>
                        <th>Дата добавления</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

</div>

<script>
/* ---------------------------------------
   Загрузка данных и работа с таблицей
--------------------------------------- */
async function loadTable() {
    const res = await fetch('/api/emails');
    const data = await res.json();

    const tbody = document.querySelector('#emailsTable tbody');
    
    // Сохраняем состояние чекбоксов перед обновлением
    const checkedIds = new Set();
    document.querySelectorAll('.email-checkbox:checked').forEach(cb => {
        checkedIds.add(cb.value);
    });
    const selectAllChecked = document.getElementById('selectAll').checked;

    tbody.innerHTML = '';

    data.forEach(row => {
        const tr = document.createElement('tr');
        const isChecked = checkedIds.has(row.id.toString());
        const trackingLink = row.tracking_link || '';
        const isUsed = row.is_used || false;
        const clicksCount = row.clicks_count || 0;
        
        // Создаем бейдж статуса
        let statusBadge = '';
        if (isUsed) {
            statusBadge = `<span class="badge bg-success">Использовано (${clicksCount})</span>`;
        } else {
            statusBadge = `<span class="badge bg-warning text-dark">Не использовано</span>`;
        }
        
        tr.innerHTML = `
            <td><input type="checkbox" value="${row.id}" class="email-checkbox" ${isChecked ? 'checked' : ''}></td>
            <td>${row.id}</td>
            <td>${row.email}</td>
            <td>
                ${trackingLink ? `
                    <div class="d-flex align-items-center gap-2">
                        <code class="mb-0" style="font-size: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${trackingLink}</code>
                        <button class="btn btn-sm btn-outline-secondary" onclick="copyLink('${trackingLink}', this)" title="Копировать ссылку">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M4 1.5H3a2 2 0 0 0-2 2V14a2 2 0 0 0 2 2h10a2 2 0 0 0 2-2V3.5a2 2 0 0 0-2-2h-1v1h1a1 1 0 0 1 1V14a1 1 0 0 1-1V3.5a1 1 0 0 1-1V2H4v-.5z"/>
                                <path d="M9.5 1a.5.5 0 0 1 .5.5v13a.5.5 0 0 1-.5.5h-3a.5.5 0 0 1-.5-.5v-13a.5.5 0 0 1 .5-.5h3zm-3-1A1.5 1.5 0 0 0 5 1.5v13A1.5 1.5 0 0 0 6.5 16h3a1.5 1.5 0 0 0 1.5-1.5v-13A1.5 1.5 0 0 0 9.5 0h-3z"/>
                            </svg>
                        </button>
                    </div>
                ` : '<span class="text-muted">-</span>'}
            </td>
            <td>${statusBadge}</td>
            <td>${row.created_at || '-'}</td>
        `;
        tbody.appendChild(tr);
    });

    document.getElementById('rowCount').innerText =
        `Всего email адресов: ${data.length}`;
    
    // Восстанавливаем состояние чекбокса "Выбрать все"
    document.getElementById('selectAll').checked = selectAllChecked;
    
    // Если все чекбоксы были выбраны, проверяем, все ли еще выбраны
    if (selectAllChecked) {
        const allCheckboxes = document.querySelectorAll('.email-checkbox');
        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
        if (!allChecked) {
            document.getElementById('selectAll').checked = false;
        }
    }
}

function copyLink(link, button) {
    function showSuccess() {
        const originalHTML = button.innerHTML;
        button.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>';
        button.classList.remove('btn-outline-secondary');
        button.classList.add('btn-success');
        setTimeout(() => {
            button.innerHTML = originalHTML;
            button.classList.remove('btn-success');
            button.classList.add('btn-outline-secondary');
        }, 2000);
    }

    function fallbackCopy(text) {
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-999999px';
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        try {
            document.execCommand('copy');
            document.body.removeChild(textArea);
            showSuccess();
        } catch (err) {
            document.body.removeChild(textArea);
            alert('Не удалось скопировать ссылку');
        }
    }

    // Пытаемся использовать moderne Clipboard API
    if (navigator.clipboard && navigator.clipboard.writeText) {
        navigator.clipboard.writeText(link).then(() => {
            showSuccess();
        }).catch(err => {
            // Fallback на старый метод при ошибке
            fallbackCopy(link);
        });
    } else {
        // Для браузеров без поддержки Clipboard API
        fallbackCopy(link);
    }
}

function toggleSelectAll() {
    const selectAll = document.getElementById('selectAll');
    const checkboxes = document.querySelectorAll('.email-checkbox');
    checkboxes.forEach(cb => cb.checked = selectAll.checked);
}

async function deleteSelected() {
    const checked = document.querySelectorAll(
        '.email-checkbox:checked'
    );

    if (!checked.length) {
        alert('Выберите email адреса для удаления');
        return;
    }

    if (!confirm(`Удалить ${checked.length} выбранных email адресов?`)) return;

    const ids = Array.from(checked).map(cb => cb.value);

    await fetch('/api/emails/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRF-Token': '{{ csrf_token() }}'
        },
        body: JSON.stringify({ ids })
    });

    loadTable();
}

async function uploadEmails() {
    const emailList = document.getElementById('emailList').value.trim();
    
    if (!emailList) {
        alert('Введите email адреса для загрузки');
        return;
    }

    const resultDiv = document.getElementById('uploadResult');
    resultDiv.innerHTML = '<div class="alert alert-info">Загрузка...</div>';

    try {
        const res = await fetch('/api/emails', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ emails: emailList })
        });

        const data = await res.json();

        if (res.ok) {
            let message = `<div class="alert alert-success">
                <strong>Успешно!</strong><br>
                Добавлено: ${data.added}<br>
                Пропущено: ${data.skipped}
            </div>`;
            
            if (data.errors && data.errors.length > 0) {
                message += `<div class="alert alert-warning mt-2">
                    <strong>Ошибки:</strong><br>
                    ${data.errors.join('<br>')}
                </div>`;
            }
            
            resultDiv.innerHTML = message;
            
            // Очистка поля ввода
            document.getElementById('emailList').value = '';
            
            // Обновление таблицы
            loadTable();
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Ошибка при загрузке'}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
    }
}

/* ---------------------------------------
   Drag and Drop для файлов
--------------------------------------- */
const uploadArea = document.getElementById('uploadArea');
const emailListTextarea = document.getElementById('emailList');

uploadArea.addEventListener('dragover', (e) => {
    e.preventDefault();
    uploadArea.classList.add('dragover');
});

uploadArea.addEventListener('dragleave', () => {
    uploadArea.classList.remove('dragover');
});

uploadArea.addEventListener('drop', async (e) => {
    e.preventDefault();
    uploadArea.classList.remove('dragover');

    const file = e.dataTransfer.files[0];
    if (!file) return;

    const fileName = file.name.toLowerCase();
    
    // Обработка xlsx файлов - загружаем напрямую на сервер
    if (fileName.endsWith('.xlsx') || fileName.endsWith('.xls')) {
        await uploadFile(file);
        return;
    }
    
    // Обработка текстовых файлов - показываем в textarea
    if (file.type === 'text/plain' || fileName.endsWith('.txt') || fileName.endsWith('.csv')) {
        const text = await file.text();
        emailListTextarea.value = text;
    } else {
        alert('Поддерживаются только файлы: .xlsx, .txt, .csv');
    }
});

// Функция для загрузки файла на сервер
async function uploadFile(file) {
    const resultDiv = document.getElementById('uploadResult');
    resultDiv.innerHTML = '<div class="alert alert-info">Загрузка файла...</div>';

    const formData = new FormData();
    formData.append('file', file);

    try {
        const res = await fetch('/api/emails/upload', {
            method: 'POST',
            headers: {
                'X-CSRF-Token': '{{ csrf_token() }}'
            },
            body: formData
        });

        const data = await res.json();

        if (res.ok) {
            let message = `<div class="alert alert-success">
                <strong>Успешно!</strong><br>
                Добавлено: ${data.added}<br>
                Пропущено: ${data.skipped}
            </div>`;
            
            if (data.errors && data.errors.length > 0) {
                message += `<div class="alert alert-warning mt-2">
                    <strong>Ошибки:</strong><br>
                    ${data.errors.slice(0, 10).join('<br>')}
                    ${data.errors.length > 10 ? `<br>... и еще ${data.errors.length - 10} ошибок` : ''}
                </div>`;
            }
            
            resultDiv.innerHTML = message;
            
            // Обновление таблицы
            loadTable();
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Ошибка при загрузке файла'}</div>`;
        }
    } catch (error) {
        resultDiv.innerHTML = `<div class="alert alert-danger">Ошибка: ${error.message}</div>`;
    }
}

/* ---------------------------------------
   Таймер автовыхода
--------------------------------------- */
const IDLE_TIMEOUT_MS = 5 * 60 * 1000;
let idleTimer = null;

function logoutUser() {
    alert('Сессия истекла из-за неактивности.');
    window.location.href = '/logout';
}

function resetIdleTimer() {
    if (idleTimer) clearTimeout(idleTimer);
    idleTimer = setTimeout(logoutUser, IDLE_TIMEOUT_MS);
}

['mousemove', 'keypress', 'click', 'scroll', 'touchstart'].forEach(evt => {
    document.addEventListener(evt, resetIdleTimer, true);
});

resetIdleTimer();

/* ---------------------------------------
   Инициализация
--------------------------------------- */
loadTable();
setInterval(loadTable, 5000);
</script>

</body>
</html>
